name: üöÄ Daily DeFi Pipeline

on:
  schedule:
    - cron: '0 0 * * *'   # Every day at midnight UTC
  workflow_dispatch:        # Allow manual triggering from GitHub UI
    inputs:
      source:
        description: 'Data source to extract (all / etherscan / defillama / dune / coingecko)'
        required: false
        default: 'all'

env:
  PYTHON_VERSION: '3.12'
  DBT_PROFILES_DIR: ./dbt_project

jobs:
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # JOB 1: Extract data from all APIs
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  extract:
    name: üêç Extract
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: defi_pipeline
          POSTGRES_USER: pipeline
          POSTGRES_PASSWORD: pipeline_secret
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üêç Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: üì¶ Install dependencies
        run: pip install -r requirements.txt

      - name: üóÉÔ∏è Initialize database schema
        run: psql $DATABASE_URL -f docker/init.sql
        env:
          DATABASE_URL: postgresql://pipeline:pipeline_secret@localhost:5432/defi_pipeline

      - name: üîÑ Run extraction pipeline
        run: |
          python -m extract.run_extraction \
            --source ${{ github.event.inputs.source || 'all' }}
        env:
          ETHERSCAN_API_KEY:  ${{ secrets.ETHERSCAN_API_KEY }}
          DUNE_API_KEY:       ${{ secrets.DUNE_API_KEY }}
          COINGECKO_API_KEY:  ${{ secrets.COINGECKO_API_KEY }}
          DATABASE_URL:       postgresql://pipeline:pipeline_secret@localhost:5432/defi_pipeline
          DB_HOST:            localhost
          DB_PORT:            '5432'
          DB_NAME:            defi_pipeline
          DB_USER:            pipeline
          DB_PASSWORD:        pipeline_secret
          LOG_LEVEL:          INFO

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # JOB 2: Transform with dbt (runs after extract)
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  transform:
    name: üîß Transform (dbt)
    needs: extract
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: defi_pipeline
          POSTGRES_USER: pipeline
          POSTGRES_PASSWORD: pipeline_secret
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - run: pip install dbt-core dbt-postgres

      - name: üì¶ Install dbt packages
        working-directory: ./dbt_project
        run: dbt deps --no-use-colors

      - name: üå± Load seed data
        working-directory: ./dbt_project
        run: dbt seed --target prod --no-use-colors
        env:
          DB_HOST:     localhost
          DB_PORT:     '5432'
          DB_NAME:     defi_pipeline
          DB_USER:     pipeline
          DB_PASSWORD: pipeline_secret

      - name: üèóÔ∏è Run dbt models
        working-directory: ./dbt_project
        run: dbt run --target prod --no-use-colors
        env:
          DB_HOST:     localhost
          DB_PORT:     '5432'
          DB_NAME:     defi_pipeline
          DB_USER:     pipeline
          DB_PASSWORD: pipeline_secret

      - name: ‚úÖ Run dbt tests
        working-directory: ./dbt_project
        run: dbt test --target prod --no-use-colors
        env:
          DB_HOST:     localhost
          DB_PORT:     '5432'
          DB_NAME:     defi_pipeline
          DB_USER:     pipeline
          DB_PASSWORD: pipeline_secret

      - name: üìä Generate dbt docs
        working-directory: ./dbt_project
        run: dbt docs generate --target prod --no-use-colors
        env:
          DB_HOST:     localhost
          DB_PORT:     '5432'
          DB_NAME:     defi_pipeline
          DB_USER:     pipeline
          DB_PASSWORD: pipeline_secret

      - name: üì§ Upload dbt artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dbt-docs-${{ github.run_number }}
          path: dbt_project/target/
          retention-days: 30
