# ðŸ“Š DeFi Protocol Revenue & User Attribution Pipeline (PoC)

> **Disclaimer: This repository is a Proof of Concept (PoC) / test project built to demonstrate a modern data engineering workflow.**
> It serves as a showcase of extracting, loading, and transforming (ELT) on-chain and off-chain data to answer complex growth analytics questions in DeFi.

[![dbt](https://img.shields.io/badge/dbt-v1.8-orange.svg)](https://www.getdbt.com/)
[![Python](https://img.shields.io/badge/Python-3.12-blue.svg)](https://python.org)
[![PostgreSQL](https://img.shields.io/badge/PostgreSQL-16-316192.svg)](https://postgresql.org)
[![Evidence](https://img.shields.io/badge/Evidence.dev-BI-brightgreen.svg)](https://evidence.dev/)

---

## ðŸ“¸ Dashboard Previews

Here are some screenshots of the final Evidence.dev BI dashboard that this pipeline generates:

### Main Attribution Dashboard
![Main Dashboard](docs/dashboard_main.webp)

### Cohort Retention & BADE Metrics
![BADE Metrics](docs/dashboard_bade.webp)

### Sybil & Bot Detection
![Sybil Chart](docs/sybil_chart.png)

---

## ðŸŽ¯ Business Problem

DeFi protocols spend **millions on marketing incentives** (liquidity mining rewards, token airdrops, governance participation bonuses) but most cannot answer a fundamental question:

> *"Which acquisition channel brings users who actually stay and generate revenue, versus users who farm the incentive and leave?"*

This pipeline extracts transaction data from **Uniswap V3** and **Aave V3**, enriches it with behavioral labels, and builds a **cohort retention & revenue attribution data mart**. 

### Key Insight from the Data (Simulated)
> 70% of protocol revenue is generated by wallets acquired through **governance participation** and **organic discovery**, while **airdrop farmers** show < 5% Week-4 retention.

---

## ðŸ—ï¸ Architecture

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         EXTRACT (Python)                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Etherscan  â”‚  â”‚  DeFiLlama   â”‚  â”‚    Dune    â”‚  â”‚CoinGecko â”‚  â”‚
â”‚  â”‚     API     â”‚  â”‚     API      â”‚  â”‚ Analytics  â”‚  â”‚   API    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â–¼                â–¼                â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         LOAD (PostgreSQL)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        TRANSFORM (dbt)                              â”‚
â”‚  Staging â†’ stg_etherscan, stg_defillama, stg_dune, stg_coingecko    â”‚
â”‚  Marts   â†’ fct_cohort_retention, fct_daily_revenue_attribution      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ORCHESTRATE + VISUALIZE                        â”‚
â”‚                Evidence.dev Dashboard (Docs-as-code)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ðŸ“ˆ Key Metrics Produced

| Metric | Definition | Business Value |
|--------|-----------|----------------|
| **Cohort Retention Rate** | % of wallets active N weeks after first interaction | Identifies "sticky" vs "mercenary" users |
| **Revenue per Cohort** | USD revenue generated by each acquisition cohort | LTV by acquisition channel |
| **CAC Equivalent** | Token incentives spent / new wallets in cohort | Cost of user acquisition |
| **Protocol Revenue Daily** | Estimated fees in USD per protocol | Unit economics health |
| **Bot Activity Index (BADE)** | Algorithmic detection of bot-like transaction patterns | Security & fraud detection |

---

## ðŸ› ï¸ Tech Stack

- **Extract**: Python 3.12, `requests`, OOP-based extractors with standard interfaces.
- **Load**: `SQLAlchemy`, PostgreSQL 16 (upsert/full-refresh).
- **Transform**: `dbt-core`, SQL Window Functions, modular data modeling.
- **Visualize**: Evidence.dev (Markdown-based BI).
- **Containerization**: Docker Compose.

---

## ðŸš€ Running the PoC Locally

### 1. Configure
```bash
cp .env.example .env
# Edit .env with your free API keys for Etherscan, Dune, and CoinGecko
```

### 2. Start Database
```bash
make db-up
```

### 3. Run Pipeline (Extract + Transform)
```bash
make setup
make extract
make transform
```

### 4. View Dashboard
```bash
cd evidence
npm install
npm run dev
# Open http://localhost:3000
```

---

## ðŸ“ Proof of Concept Notes

Since this is a PoC/Test project:
- **Mock Data Fallbacks**: Certain endpoints (like premium Dune queries) fallback to deterministic mock data leveraging actual blockchain addresses pulled from Etherscan to ensure downstream JOINs succeed.
- **Historical Data Simulation**: To overcome free-tier API limitations (like CoinGecko's 365-day limit), historical asset prices for 2021-2023 are deterministically padded to match Etherscan historical ranges.

---

> *Built as a demonstration of modern Analytics Engineering: combining ELT data pipelines, modular SQL transformations, and docs-as-code BI.*
